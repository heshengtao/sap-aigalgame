<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AI Galgame</title>
<link rel="stylesheet" href="all.min.css">
<style>
:root{
  --text: #e8e8e8;
  --accent: #ff6b35;
  --border: rgba(255,255,255,.15);
  --radius: 12px;
  --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font); }
html,body{ height: 100%; overflow: hidden; }
body{
  background: #000 url("background/sea.png") center/cover no-repeat;
  color: var(--text); font-size: 16px; line-height: 1.6;
}
/* ç«‹ç»˜å±‚ */
#characterLayer{
  position: absolute; inset: 0; z-index: 1;
  display: flex; align-items: flex-end; justify-content: center;
  pointer-events: none;
}
#characterLayer img{
  width: 90vw; max-width: 900px; height: 90%; max-height: 100vh;
  object-fit: contain; object-position: bottom center;
  transition: opacity .25s ease;
}
/* å¥½æ„Ÿåº¦ */
#loveMeter{
  position: absolute; top: 20px; left: 20px; z-index: 10;
  display: flex; gap: 8px; background: rgba(0,0,0,.35);
  padding: 8px 12px; border-radius: var(--radius); backdrop-filter: blur(6px);
}
.heart{ font-size: 24px; color: var(--accent); }
.heart.empty{ color: var(--border); }
/* å¯¹è¯æ¡† */
#talkBox{
  position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
  width: 90vw; max-width: 800px; background: rgba(0,0,0,.45);
  border: 1px solid var(--border); border-radius: var(--radius);
  padding: 20px 24px; z-index: 10; backdrop-filter: blur(8px);
  min-height: 100px;
}
#talkBox .name{ color: var(--accent); font-weight: bold; margin-bottom: 8px; }
#talkBox .text{ font-size: 18px; line-height: 1.7; white-space: pre-wrap; }
/* è¾“å…¥æ¡† */
#inputBox{
  position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
  width: 90vw; max-width: 800px; display: flex; gap: 10px; z-index: 10;
}
#inputBox input{
  flex: 1; background: rgba(0,0,0,.45); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 12px 16px; color: var(--text);
  font-size: 16px; backdrop-filter: blur(8px);
}
#inputBox input:focus{ outline: none; border-color: var(--accent); }
#inputBox button{
  background: var(--accent); border: none; border-radius: var(--radius);
  padding: 0 20px; color: #fff; font-size: 16px; cursor: pointer;
  transition: background .3s;
}
#inputBox button:hover{ background: #ff8559; }
/* å³ä¸Šè§’æŒ‰é’® */
#settingsButtons{
  position: absolute; top: 20px; right: 20px; z-index: 10;
  display: flex; gap: 10px;
}
#settingsButtons button{
  background: rgba(0,0,0,.35); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 10px 15px; color: var(--text);
  font-size: 16px; cursor: pointer; backdrop-filter: blur(6px);
  transition: background .3s;
}
#settingsButtons button:hover{ background: rgba(0,0,0,.5); }
/* æ¨¡æ€æ¡† */
.modal{
  display: none; position: fixed; inset: 0; z-index: 100;
  background: rgba(0,0,0,.7); backdrop-filter: blur(10px);
}
.modal.active{ display: flex; align-items: center; justify-content: center; }
.modal-content{
  background: rgba(20,20,20,.9); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 30px; max-width: 90vw; max-height: 80vh;
  overflow-y: auto; position: relative;
  width: 60%;
}
.modal-header{
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 20px;
}
.modal-header h2{ color: var(--accent); }
.close-btn{
  background: none; border: none; color: var(--text); font-size: 24px;
  cursor: pointer; padding: 5px;
}
.close-btn:hover{ color: var(--accent); }
.grid{
  display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 15px;
}
.grid-item{
  background: rgba(255,255,255,.05); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 10px; cursor: pointer;
  text-align: center; transition: all .3s;
}
.grid-item:hover{ background: rgba(255,255,255,.1); border-color: var(--accent); }
.grid-item img{
  width: 100%; height: 100px; object-fit: cover; border-radius: 8px;
  margin-bottom: 8px;
}
.grid-item p{ font-size: 14px; color: var(--text); }
/* =====  é€‰é¡¹æ¨¡å¼  ===== */
.hidden{ display:none !important; }
#choiceBox{
  position:absolute;
  bottom:30px;
  left:50%;
  transform:translateX(-50%);
  width:90vw; max-width:800px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  z-index:10;
}
.choice{
  background:rgba(0,0,0,.45);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:14px 12px;
  color:var(--text);
  font-size:16px;
  cursor:pointer;
  backdrop-filter:blur(8px);
  transition:border-color .3s;
  text-align:center;
}
.choice:hover{ border-color:var(--accent); }
:root{
  --input-height: 60px;   /* åˆå§‹å ä½ï¼ŒJSä¼šç›–æ‰ */
}
#talkBox{
  bottom: calc(30px + var(--input-height) + 20px); /* 30=åº•éƒ¨ç•™ç™½,20=é—´è· */
  max-height: calc(100vh - var(--input-height) - 120px); /* 120=ä¸Šä¸‹é¢å¤–ç•™ç™½ */
  overflow-y: auto;
  transition: bottom .3s ease, max-height .3s ease;
}
#choiceBox{
  gap: 10px;
}
</style>
</head>
<body>

<!-- ç«‹ç»˜ -->
<div id="characterLayer">
  <img id="charImg" src="person/alice/normal.png" alt=""/>
</div>

<!-- å¥½æ„Ÿåº¦ -->
<div id="loveMeter">
  <i class="fa-solid fa-heart heart" data-index="1"></i>
  <i class="fa-solid fa-heart heart" data-index="2"></i>
  <i class="fa-solid fa-heart heart" data-index="3"></i>
  <i class="fa-solid fa-heart heart" data-index="4"></i>
  <i class="fa-solid fa-heart heart" data-index="5"></i>
  <i class="fa-solid fa-heart heart empty" data-index="6"></i>
  <i class="fa-solid fa-heart heart empty" data-index="7"></i>
  <i class="fa-solid fa-heart heart empty" data-index="8"></i>
  <i class="fa-solid fa-heart heart empty" data-index="9"></i>
  <i class="fa-solid fa-heart heart empty" data-index="10"></i>
</div>

<!-- å³ä¸Šè§’æŒ‰é’® -->
<div id="settingsButtons">
  <button id="modeBtn"><i class="fas fa-exchange-alt"></i> è‡ªåŠ¨</button>
  <button id="bgBtn"><i class="fas fa-image"></i> èƒŒæ™¯</button>
  <button id="charBtn"><i class="fas fa-user"></i> äººç‰©</button>
</div>

<!-- å¯¹è¯æ¡† -->
<div id="talkBox">
  <div class="name" id="charName">Alice</div>
  <div class="text" id="talkText"></div>
</div>

<!-- è¾“å…¥ -->
<div id="inputBox">
  <input id="userInput" type="text" placeholder="è¾“å…¥æƒ³è¯´çš„è¯ï¼Œå›è½¦å‘é€" autocomplete="off"/>
  <button id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
</div>

<div id="choiceBox" class="hidden">
  <button class="choice" data-index="0"></button>
  <button class="choice" data-index="1"></button>
  <button class="choice" data-index="2"></button>
  <button class="choice" data-index="3"></button>
</div>

<!-- èƒŒæ™¯é€‰æ‹©æ¨¡æ€æ¡† -->
<div id="bgModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>é€‰æ‹©èƒŒæ™¯</h2>
      <button class="close-btn" onclick="closeModal('bgModal')">&times;</button>
    </div>
    <div id="bgGrid" class="grid"></div>
  </div>
</div>

<!-- äººç‰©é€‰æ‹©æ¨¡æ€æ¡† -->
<div id="charModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>é€‰æ‹©äººç‰©</h2>
      <button class="close-btn" onclick="closeModal('charModal')">&times;</button>
    </div>
    <div id="charGrid" class="grid"></div>
  </div>
</div>

<script>
  /* =========================  çŠ¶æ€  ========================= */
let ws;
let isGenerating = false;
let currentLove = 5;
let currentEmotion = 'normal';
let lastRaw = '';
let pendingState = null;
let backgroundList = []; // å­˜å‚¨æ‰€æœ‰èƒŒæ™¯åˆ—è¡¨

// è¯»å–ä¸Šæ¬¡ç”¨æˆ·é€‰æ‹©
let currentBg   = localStorage.getItem('selectedBg')   || 'sea';
let currentChar = localStorage.getItem('selectedChar') || 'alice';
let currentCharName = currentChar.charAt(0).toUpperCase() + currentChar.slice(1);

const emotions = {
  normal: 'normal.png',
  happy : 'happy.png',
  angry : 'angry.png',
  sad   : 'sad.png',
  fear  : 'fear.png'
};

/* =========================  å·¥å…·  ========================= */
function setLove(n) {
  currentLove = Math.max(0, Math.min(10, n));
  document.querySelectorAll('.heart').forEach((h, i) =>
    h.classList.toggle('empty', i >= currentLove)
  );
}
function setEmotion(e) {
  if (!emotions[e]) e = 'normal';
  if (e === currentEmotion) return;
  currentEmotion = e;
  const img = document.getElementById('charImg');
  img.style.opacity = 0;
  requestAnimationFrame(() => {
    img.src = `person/${currentChar}/${emotions[e]}`;
    img.style.opacity = 1;
  });
}
function streamTalk(txt) {
  document.getElementById('talkText').innerHTML = txt;
}

/* =========================  æ¨¡æ€æ¡†  ========================= */
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

/* åŠ¨æ€åŠ è½½èƒŒæ™¯åˆ—è¡¨ */
async function loadBackgrounds() {
  const res  = await fetch('background/index.json');
  const list = await res.json();
  backgroundList = list.map(file => file.replace('.png', '')); // ä¿å­˜èƒŒæ™¯åˆ—è¡¨
  const grid = document.getElementById('bgGrid');
  grid.innerHTML = '';
  list.forEach(file => {
    const name = file.replace('.png', '');
    const item = document.createElement('div');
    item.className = 'grid-item';
    item.innerHTML = `<img src="background/${file}" loading="lazy"><p>${name}</p>`;
    item.onclick = () => selectBackground(name);
    grid.appendChild(item);
  });
}

/* åŠ¨æ€åŠ è½½äººç‰©åˆ—è¡¨ */
async function loadCharacters() {
  const res  = await fetch('person/index.json');
  const list = await res.json();
  const grid = document.getElementById('charGrid');
  grid.innerHTML = '';
  list.forEach(folder => {
    const item = document.createElement('div');
    item.className = 'grid-item';
    item.innerHTML = `<img src="person/${folder}/normal.png" loading="lazy"><p>${folder}</p>`;
    item.onclick = () => selectCharacter(folder);
    grid.appendChild(item);
  });
}

function selectBackground(name) {
  currentBg = name;
  document.body.style.backgroundImage = `url(background/${name}.png)`;
  localStorage.setItem('selectedBg', name);
  closeModal('bgModal');
  updateSystemPromptWithBackground(); // èƒŒæ™¯åˆ‡æ¢æ—¶æ›´æ–°ç³»ç»Ÿæç¤ºè¯
}

function selectCharacter(folder) {
  currentChar = folder;
  currentCharName = folder.charAt(0).toUpperCase() + folder.slice(1);
  document.getElementById('charName').textContent = currentCharName;
  document.getElementById('charImg').src = `person/${folder}/normal.png`;
  localStorage.setItem('selectedChar', folder);
  closeModal('charModal');
}

/* åº”ç”¨ä¸Šæ¬¡ä¿å­˜çš„è®¾ç½® */
function applySaved() {
  document.body.style.backgroundImage = `url(background/${currentBg}.png)`;
  document.getElementById('charName').textContent = currentCharName;
  document.getElementById('charImg').src = `person/${currentChar}/normal.png`;
}

/* =========================  WebSocket  ========================= */
function initWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  ws.onopen  = async () =>  {
    console.log('WS connected');
    await loadBackgrounds();
    updateSystemPromptWithBackground(); // è¿æ¥å»ºç«‹åå‘é€åˆå§‹ç³»ç»Ÿæç¤ºè¯
  };
  ws.onclose = () => setTimeout(initWS, 3000);
  ws.onmessage = e => {
    try {
      const d = JSON.parse(e.data);
      if (d.type === 'messages_update' || d.type === 'broadcast_messages') {
        const msgs = d.data.messages;
        if (msgs.length) {
          const m = msgs[msgs.length - 1];
          if (m.role === 'assistant') parseAndRender(m.content);
        }
      }
    } catch {}
  };
}

function parseAndRender(raw) {
  if (raw === lastRaw) return;
  lastRaw = raw;

  const talkOpen  = raw.lastIndexOf('<talk>');
  const talkClose = raw.lastIndexOf('</talk>');
  if (talkOpen !== -1) {
    const currentTalk = talkClose === -1 || talkClose < talkOpen
                      ? raw.substring(talkOpen + 6)
                      : raw.substring(talkOpen + 6, talkClose);
    streamTalk(currentTalk);
  }

  const st = (raw.match(/<state>([\s\S]*?)<\/state>/) || [])[1]?.trim();
  const lv = parseInt((raw.match(/<love>([\s\S]*?)<\/love>/) || [])[1]);
  if (st || !isNaN(lv)) {
    if (!pendingState) pendingState = {};
    if (st) pendingState.emotion = st;
    if (!isNaN(lv)) pendingState.love = lv;
  }
  if (raw.includes('</talk>') && pendingState) {
    if (pendingState.emotion) setEmotion(pendingState.emotion);
    if (pendingState.love != null) setLove(pendingState.love);
    pendingState = null;
  }
}

function send(msg) {
  if (!ws || ws.readyState !== 1 || !msg.trim() || isGenerating) return;
  isGenerating = true;
  ws.send(JSON.stringify({ type: 'set_user_input', data: { text: msg } }));
  ws.send(JSON.stringify({ type: 'trigger_send_message' }));
  setTimeout(() => (isGenerating = false), 600);
}

function updateSystemPrompt(msg) {
  if (!ws || ws.readyState !== 1 || !msg.trim() || isGenerating) return;
  isGenerating = true;
  ws.send(JSON.stringify({ type: 'set_system_prompt', data: { text: msg } }));
  setTimeout(() => (isGenerating = false), 600);
}

/* ========== åŠ¨æ€ç”ŸæˆåŒ…å«èƒŒæ™¯ä¿¡æ¯çš„ç³»ç»Ÿæç¤ºè¯ ========== */
function updateSystemPromptWithBackground() {
  // åŸºç¡€æç¤ºè¯æ¨¡æ¿
  let basePrompt = mode === 'chat' ? 
    `ä½ æ˜¯ä¸€ä¸ªGalgameè§’è‰²AIã€‚è¯·æ ¹æ®ç©å®¶è¾“å…¥ï¼Œä»¥XMLæ ¼å¼è¿”å›ï¼š
<talk>è§’è‰²å›å¤ï¼ˆå£è¯­åŒ–ã€å¯çˆ±ã€æœ‰æƒ…ç»ªï¼‰</talk>
<silence><state>normal|happy|angry|sad|fear</state></silence>
<silence><love>0~10æ•´æ•°</love></silence>
<silence><bg>ä½ è¦åˆ‡æ¢çš„èƒŒæ™¯å›¾ï¼ˆå¯é€‰ï¼Œä¸åˆ‡æ¢æ—¶ï¼Œä¸ç”¨ç”Ÿæˆï¼‰</bg></silence>

è§„åˆ™ï¼š
1. åˆå§‹å¥½æ„Ÿ5ï¼Œéšç©å®¶è¡¨ç°å¢å‡
2. è¡¨æƒ…ä¸å¯¹è¯æƒ…ç»ªä¸€è‡´
3. å›å¤20~60å­—ï¼Œè‡ªç„¶äº²åˆ‡` : 
    `ä½ æ˜¯ä¸€ä¸ªGalgameè§’è‰²AIã€‚è¯·æ ¹æ®ç©å®¶è¾“å…¥ç”Ÿæˆå›å¤å’Œå››ä¸ªæ¸¸æˆé€‰é¡¹ï¼Œä»¥XMLæ ¼å¼è¿”å›ï¼š
<talk>è§’è‰²å›å¤ï¼ˆå£è¯­åŒ–ã€å¯çˆ±ã€æœ‰æƒ…ç»ªï¼‰</talk>
<silence><option>é€‰é¡¹A</option></silence>
<silence><option>é€‰é¡¹B</option></silence>
<silence><option>é€‰é¡¹C</option></silence>
<silence><option>é€‰é¡¹d</option></silence>
<silence><state>normal|happy|angry|sad|fear</state></silence>
<silence><love>0~10æ•´æ•°</love></silence>
<silence><bg>ä½ è¦åˆ‡æ¢çš„èƒŒæ™¯å›¾ï¼ˆå¯é€‰ï¼Œä¸åˆ‡æ¢æ—¶ï¼Œä¸ç”¨ç”Ÿæˆï¼‰</bg></silence>
è§„åˆ™ï¼š
1. åˆå§‹å¥½æ„Ÿ5ï¼Œéšç©å®¶è¡¨ç°å¢å‡
2. è¡¨æƒ…ä¸å¯¹è¯æƒ…ç»ªä¸€è‡´
3. å›å¤20~60å­—ï¼Œè‡ªç„¶äº²åˆ‡`;

  // æ·»åŠ èƒŒæ™¯ä¿¡æ¯
  let backgroundInfo = `\n\nå½“å‰åœºæ™¯èƒŒæ™¯: ${currentBg}`;
  if (backgroundList.length > 0) {
    backgroundInfo += `\nå¯é€‰èƒŒæ™¯åˆ—è¡¨: ${backgroundList.join(', ')}`;
  }
  
  // ç»„åˆå®Œæ•´çš„æç¤ºè¯
  const fullPrompt = basePrompt + backgroundInfo;
  updateSystemPrompt(fullPrompt);
}

/* =========================  è¾“å…¥ç»‘å®š  ========================= */
const ui = document.getElementById('userInput');
ui.addEventListener('keydown', e => {
  if (e.key === 'Enter') { send(ui.value); ui.value = ''; }
});
document.getElementById('sendBtn').addEventListener('click', () => {
  send(ui.value); ui.value = '';
});

/* æ¨¡æ€æ¡†æŒ‰é’® */
document.getElementById('bgBtn').addEventListener('click', () => {
  loadBackgrounds(); openModal('bgModal');
});
document.getElementById('charBtn').addEventListener('click', () => {
  loadCharacters(); openModal('charModal');
});

/* =========================  å…¥å£  ========================= */
document.addEventListener('DOMContentLoaded', () => {
  applySaved();
  setLove(5);
  setEmotion('normal');
  initWS();
  loadBackgrounds(); // åŠ è½½èƒŒæ™¯åˆ—è¡¨
});
/* ==========  æ¨¡å¼åˆ‡æ¢  ========== */
let mode = 'chat';            // chat | choice
const modeBtn = document.getElementById('modeBtn');
const inputBox  = document.getElementById('inputBox');
const choiceBox = document.getElementById('choiceBox');
const choiceBtns = Array.from(document.querySelectorAll('.choice'));

/* ==========  æ¨¡å¼åˆ‡æ¢  ========== */
modeBtn.onclick = () => {
  mode = mode === 'chat' ? 'choice' : 'chat';
  modeBtn.innerHTML = mode === 'chat'
        ? '<i class="fas fa-exchange-alt"></i> è‡ªåŠ¨'
        : '<i class="fas fa-comment-dots"></i> æ‰‹åŠ¨';
  inputBox.classList.toggle('hidden',  mode === 'choice');
  choiceBox.classList.toggle('hidden', mode === 'chat');

  /* æ›´æ–°åç«¯ç³»ç»Ÿæç¤ºè¯ */
  updateSystemPromptWithBackground();

  //ç­‰å¾…1ç§’
  setTimeout(function() {
    /* ğŸ”¥ åˆ‡åˆ°é€‰é¡¹æ¨¡å¼æ—¶ï¼Œè‡ªåŠ¨è®© AI å¼€å±€ */
    if (mode === 'choice') {
      send('è¯·æ ¹æ®å½“å‰äººè®¾å¼€å§‹æ‰®æ¼”å¹¶ç”Ÿæˆé€‰é¡¹');
    }
  }, 1000);
};
/* æŠŠé€‰é¡¹å½“ç”¨æˆ·è¾“å…¥å‘å‡ºå» */
choiceBtns.forEach((btn,idx)=>{
  btn.onclick = () => send(btn.textContent);
});

/* ========== å»æ ‡ç­¾å·¥å…· ========== */
function stripTag(str){
  // å»æ‰ <option> ä¸ </option>
  return str.replace(/<\/?option>/g, '');
}

/* ========== é€‰é¡¹çœŸæ­£æµå¼ç´¯ç§¯ï¼ˆä¿®æ­£ç‰ˆï¼‰ ========== */
const optBuffers = ['','','',''];
let optWriting = 0;

function parseAndRender(raw){
  if(raw === lastRaw) return;
  lastRaw = raw;

  /* 1. å¯¹è¯éƒ¨åˆ†ï¼ˆä¿æŒåŸæ ·ï¼‰ */
  const talkOpen  = raw.lastIndexOf('<talk>');
  const talkClose = raw.lastIndexOf('</talk>');
  if(talkOpen !== -1){
    const txt = (talkClose === -1 || talkClose < talkOpen)
              ? raw.substring(talkOpen + 6)
              : raw.substring(talkOpen + 6, talkClose);
    streamTalk(txt);
  }

  /* 2. é€‰é¡¹æµå¼ï¼ˆä¸æ˜¾ç¤ºæ ‡ç­¾ï¼‰ --------------------------- */
  if(mode === 'choice'){
    let idx = 0;
    raw.replace(/<option>([\s\S]*?)<\/option>|(<option>)([\s\S]*)$/g, (m, closed, open, openFrag)=>{
      const fragment = stripTag(closed || openFrag); // å»æ‰æ ‡ç­¾
      const targetIdx = idx++;
      if(targetIdx > 3) return;
      optBuffers[targetIdx] = fragment;
      choiceBtns[targetIdx].textContent = fragment;   // çº¯æ–‡æœ¬å†™è¿›æŒ‰é’®
      optWriting = targetIdx + 1;
      return '';
    });
  }

  /* 3. èƒŒæ™¯åˆ‡æ¢ */
  const bgMatch = raw.match(/<bg>([\s\S]*?)<\/bg>/);
  if (bgMatch && bgMatch[1]) {
    const newBg = bgMatch[1].trim();
    if (backgroundList.includes(newBg)) {
      selectBackground(newBg); // åˆ‡æ¢åˆ°æ–°èƒŒæ™¯
    }
  }

  /* 4. çŠ¶æ€/å¥½æ„Ÿï¼ˆä¿æŒåŸæ ·ï¼‰ */
  const st = (raw.match(/<state>([\s\S]*?)<\/state>/) || [])[1]?.trim();
  const lv = parseInt((raw.match(/<love>([\s\S]*?)<\/love>/) || [])[1]);
  if(st || !isNaN(lv)){
    if(!pendingState) pendingState = {};
    if(st) pendingState.emotion = st;
    if(!isNaN(lv)) pendingState.love = lv;
  }
  if(raw.includes('</talk>') && pendingState){
    if(pendingState.emotion) setEmotion(pendingState.emotion);
    if(pendingState.love != null) setLove(pendingState.love);
    pendingState = null;
  }
}

/* ========== åŠ¨æ€é«˜åº¦é¿è®© ========== */
function updateInputHeight(){
  const box = (mode === 'chat') ? document.getElementById('inputBox')
                                : document.getElementById('choiceBox');
  const h = box.offsetHeight;
  document.documentElement.style.setProperty('--input-height', h + 'px');
}
/* é‡è¦èŠ‚ç‚¹è§¦å‘ */
window.addEventListener('resize', updateInputHeight);
modeBtn.addEventListener('click', () => setTimeout(updateInputHeight, 50)); // ç­‰DOMåˆ‡æ¢å®Œ
// é€‰é¡¹å†…å®¹å˜åŒ–ä¹Ÿè§¦å‘
const origParse = parseAndRender;
parseAndRender = function(raw){
  origParse(raw);
  if(mode === 'choice' && raw.includes('<option>')) updateInputHeight();
};
/* é¡µé¢åˆå§‹ */
requestAnimationFrame(updateInputHeight);
</script>

<style>
#charImg{ transition: opacity .35s ease; }
</style>
</body>
</html>
